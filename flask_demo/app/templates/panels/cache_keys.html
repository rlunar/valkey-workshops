<!-- Cache Key Inspector Panel Template -->
<div class="flDebugPanelContent">
    <h3>Cache Key Inspector</h3>
    
    {% if cache_data and not cache_data[0].get('error') %}
    <div class="flDebugPanelSection">
        <h4>Cache Keys ({{ total_keys }} total)</h4>
        
        {% if total_keys > 100 %}
        <div class="flDebugWarning" style="margin-bottom: 10px;">
            <strong>Note:</strong> Showing first 100 keys for performance reasons.
        </div>
        {% endif %}
        
        <table class="flDebugTable">
            <thead>
                <tr>
                    <th>Key</th>
                    <th>Type</th>
                    <th>TTL</th>
                    <th>Size</th>
                    <th>Value Preview</th>
                </tr>
            </thead>
            <tbody>
                {% for item in cache_data %}
                <tr>
                    <td class="flDebugCode" style="max-width: 300px; word-break: break-all;">
                        {{ item.key }}
                    </td>
                    <td>
                        <span class="flDebugType">{{ item.value_type }}</span>
                    </td>
                    <td>
                        {% if item.ttl == 'No expiration' %}
                            <span class="flDebugNeutral">{{ item.ttl }}</span>
                        {% elif item.ttl == 'N/A' %}
                            <span class="flDebugBad">{{ item.ttl }}</span>
                        {% else %}
                            <span class="flDebugGood">{{ item.ttl }}s</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if item.size > 1024 %}
                            <span class="flDebugWarning">{{ "%.1f"|format(item.size / 1024) }} KB</span>
                        {% else %}
                            {{ item.size }} B
                        {% endif %}
                    </td>
                    <td class="flDebugCode" style="max-width: 400px; word-break: break-all;">
                        {% if item.value_type == 'error' %}
                            <span class="flDebugBad">{{ item.value_preview }}</span>
                        {% else %}
                            {{ item.value_preview }}
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Cache Key Statistics -->
    <div class="flDebugPanelSection">
        <h4>Key Statistics</h4>
        <table class="flDebugTable">
            <tbody>
                <tr>
                    <td>Total Keys</td>
                    <td>{{ total_keys }}</td>
                </tr>
                <tr>
                    <td>Total Size</td>
                    <td>
                        {% set total_size = cache_data | sum(attribute='size') %}
                        {% if total_size > 1048576 %}
                            {{ "%.2f"|format(total_size / 1048576) }} MB
                        {% elif total_size > 1024 %}
                            {{ "%.1f"|format(total_size / 1024) }} KB
                        {% else %}
                            {{ total_size }} B
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td>Average Size</td>
                    <td>
                        {% if total_keys > 0 %}
                            {% set avg_size = (cache_data | sum(attribute='size')) / total_keys %}
                            {% if avg_size > 1024 %}
                                {{ "%.1f"|format(avg_size / 1024) }} KB
                            {% else %}
                                {{ "%.0f"|format(avg_size) }} B
                            {% endif %}
                        {% else %}
                            0 B
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td>Keys with TTL</td>
                    <td>
                        {% set ttl_keys = cache_data | selectattr('ttl', 'ne', 'No expiration') | selectattr('ttl', 'ne', 'N/A') | list %}
                        {{ ttl_keys | length }} ({{ "%.1f"|format((ttl_keys | length) / total_keys * 100) if total_keys > 0 else 0 }}%)
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <!-- Value Type Distribution -->
    <div class="flDebugPanelSection">
        <h4>Value Type Distribution</h4>
        <table class="flDebugTable">
            <thead>
                <tr>
                    <th>Type</th>
                    <th>Count</th>
                    <th>Percentage</th>
                </tr>
            </thead>
            <tbody>
                {% set type_counts = {} %}
                {% for item in cache_data %}
                    {% set _ = type_counts.update({item.value_type: type_counts.get(item.value_type, 0) + 1}) %}
                {% endfor %}
                
                {% for type_name, count in type_counts.items() %}
                <tr>
                    <td class="flDebugType">{{ type_name }}</td>
                    <td>{{ count }}</td>
                    <td>{{ "%.1f"|format(count / total_keys * 100) if total_keys > 0 else 0 }}%</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    {% elif cache_data and cache_data[0].get('error') %}
    <!-- Error State -->
    <div class="flDebugPanelSection">
        <h4>Connection Error</h4>
        <div class="flDebugBad">
            {{ cache_data[0].error }}
        </div>
        <p>Unable to retrieve cache keys. Make sure your cache server is running and accessible.</p>
    </div>
    
    {% else %}
    <!-- No Data State -->
    <div class="flDebugPanelSection">
        <h4>No Cache Keys Found</h4>
        <p>No cache keys were found. This could mean:</p>
        <ul>
            <li>The cache is empty</li>
            <li>No keys match the configured prefix</li>
            <li>The cache server is not accessible</li>
        </ul>
    </div>
    {% endif %}
    
    <!-- Cache Management Actions -->
    <div class="flDebugPanelSection">
        <h4>Cache Management</h4>
        <div style="margin-top: 10px;">
            <button onclick="refreshCacheKeys()" class="flDebugButton">Refresh Keys</button>
            <button onclick="clearCache()" class="flDebugButton flDebugButtonDanger">Clear All Cache</button>
        </div>
    </div>
</div>

<style>
.flDebugTable {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 10px;
}

.flDebugTable th,
.flDebugTable td {
    padding: 5px 10px;
    border: 1px solid #ddd;
    text-align: left;
    vertical-align: top;
}

.flDebugTable th {
    background-color: #f5f5f5;
    font-weight: bold;
}

.flDebugGood {
    color: #28a745;
    font-weight: bold;
}

.flDebugBad {
    color: #dc3545;
    font-weight: bold;
}

.flDebugWarning {
    color: #ffc107;
    font-weight: bold;
}

.flDebugNeutral {
    color: #6c757d;
}

.flDebugCode {
    font-family: monospace;
    background-color: #f8f9fa;
    padding: 2px 4px;
    border-radius: 3px;
    font-size: 12px;
}

.flDebugType {
    background-color: #e9ecef;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 11px;
    font-weight: bold;
    text-transform: uppercase;
}

.flDebugPanelSection {
    margin-bottom: 20px;
}

.flDebugPanelSection h4 {
    margin-bottom: 10px;
    color: #333;
    border-bottom: 1px solid #ddd;
    padding-bottom: 5px;
}

.flDebugButton {
    background-color: #007bff;
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 3px;
    cursor: pointer;
    margin-right: 5px;
    font-size: 12px;
}

.flDebugButton:hover {
    background-color: #0056b3;
}

.flDebugButtonDanger {
    background-color: #dc3545;
}

.flDebugButtonDanger:hover {
    background-color: #c82333;
}
</style>

<script>
function refreshCacheKeys() {
    // Refresh the current page to update cache key information
    window.location.reload();
}

function clearCache() {
    if (confirm('Are you sure you want to clear all cache? This action cannot be undone.')) {
        // Make a request to clear cache endpoint if available
        fetch('/clear-cache', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        }).then(response => {
            if (response.ok) {
                alert('Cache cleared successfully');
                window.location.reload();
            } else {
                alert('Failed to clear cache');
            }
        }).catch(error => {
            console.error('Error clearing cache:', error);
            alert('Error clearing cache');
        });
    }
}
</script>