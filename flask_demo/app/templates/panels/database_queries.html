<!-- Database Queries with Cache Correlation Panel Template -->
<div class="flDebugPanelContent">
    <h3>Database Queries with Cache Correlation</h3>
    
    {% if queries %}
    <!-- Query Summary -->
    <div class="flDebugPanelSection">
        <h4>Query Summary</h4>
        <table class="flDebugTable">
            <tbody>
                <tr>
                    <td>Total Queries</td>
                    <td class="{% if total_queries > 10 %}flDebugBad{% elif total_queries > 5 %}flDebugWarning{% else %}flDebugGood{% endif %}">
                        {{ total_queries }}
                    </td>
                </tr>
                <tr>
                    <td>Total Time</td>
                    <td class="{% if total_time > 1000 %}flDebugBad{% elif total_time > 500 %}flDebugWarning{% else %}flDebugGood{% endif %}">
                        {{ "%.2f"|format(total_time) }}ms
                    </td>
                </tr>
                <tr>
                    <td>Average Time</td>
                    <td>
                        {% if total_queries > 0 %}
                            {{ "%.2f"|format(total_time / total_queries) }}ms
                        {% else %}
                            0ms
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td>Queries with Cache Correlation</td>
                    <td>
                        {% set correlated_queries = queries | selectattr('related_cache_ops') | list %}
                        {{ correlated_queries | length }} ({{ "%.1f"|format((correlated_queries | length) / total_queries * 100) if total_queries > 0 else 0 }}%)
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <!-- Detailed Query List -->
    <div class="flDebugPanelSection">
        <h4>Query Details</h4>
        
        {% for query in queries %}
        <div class="flDebugQuery" style="margin-bottom: 20px; border: 1px solid #ddd; padding: 10px; border-radius: 5px;">
            <div class="flDebugQueryHeader" style="margin-bottom: 10px;">
                <strong>Query {{ loop.index }}</strong>
                <span class="flDebugQueryTime {% if query.duration > 100 %}flDebugBad{% elif query.duration > 50 %}flDebugWarning{% else %}flDebugGood{% endif %}">
                    {{ "%.2f"|format(query.duration or 0) }}ms
                </span>
                {% if query.related_cache_ops %}
                    <span class="flDebugCacheCorrelation">
                        ðŸ”— {{ query.related_cache_ops | length }} cache operation(s)
                    </span>
                {% endif %}
            </div>
            
            <!-- SQL Query -->
            <div class="flDebugQuerySQL">
                <strong>SQL:</strong>
                <pre class="flDebugCode">{{ query.statement or 'N/A' }}</pre>
            </div>
            
            <!-- Query Parameters -->
            {% if query.parameters %}
            <div class="flDebugQueryParams">
                <strong>Parameters:</strong>
                <pre class="flDebugCode">{{ query.parameters }}</pre>
            </div>
            {% endif %}
            
            <!-- Query Metadata -->
            <div class="flDebugQueryMeta">
                <table class="flDebugTable" style="margin-top: 10px;">
                    <tbody>
                        {% if query.start_time %}
                        <tr>
                            <td>Start Time</td>
                            <td>{{ "%.3f"|format(query.start_time) }}</td>
                        </tr>
                        {% endif %}
                        {% if query.end_time %}
                        <tr>
                            <td>End Time</td>
                            <td>{{ "%.3f"|format(query.end_time) }}</td>
                        </tr>
                        {% endif %}
                        {% if query.context %}
                        <tr>
                            <td>Context</td>
                            <td>{{ query.context }}</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
            
            <!-- Related Cache Operations -->
            {% if query.related_cache_ops %}
            <div class="flDebugCacheOps" style="margin-top: 10px;">
                <strong>Related Cache Operations:</strong>
                <table class="flDebugTable" style="margin-top: 5px;">
                    <thead>
                        <tr>
                            <th>Operation</th>
                            <th>Key</th>
                            <th>Result</th>
                            <th>Duration</th>
                            <th>Time Offset</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for cache_op in query.related_cache_ops %}
                        <tr>
                            <td class="{% if cache_op.operation == 'hit' %}flDebugGood{% elif cache_op.operation == 'miss' %}flDebugBad{% elif cache_op.operation == 'error' %}flDebugBad{% else %}flDebugNeutral{% endif %}">
                                {{ cache_op.operation|title }}
                            </td>
                            <td class="flDebugCode">{{ cache_op.key }}</td>
                            <td>{{ cache_op.result or 'N/A' }}</td>
                            <td>
                                {% if cache_op.duration %}
                                    {{ "%.2f"|format(cache_op.duration) }}ms
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td>
                                {% if query.start_time and cache_op.timestamp %}
                                    {{ "+%.0f"|format((cache_op.timestamp - query.start_time) * 1000) }}ms
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    
    {% else %}
    <!-- No Queries State -->
    <div class="flDebugPanelSection">
        <h4>No Database Queries</h4>
        <p>No database queries were executed during this request.</p>
    </div>
    {% endif %}
    
    <!-- Cache Operations Summary -->
    {% if cache_operations %}
    <div class="flDebugPanelSection">
        <h4>All Cache Operations ({{ cache_operations | length }})</h4>
        <table class="flDebugTable">
            <thead>
                <tr>
                    <th>Operation</th>
                    <th>Key</th>
                    <th>Result</th>
                    <th>Duration</th>
                    <th>Timestamp</th>
                </tr>
            </thead>
            <tbody>
                {% for op in cache_operations %}
                <tr>
                    <td class="{% if op.operation == 'hit' %}flDebugGood{% elif op.operation == 'miss' %}flDebugBad{% elif op.operation == 'error' %}flDebugBad{% else %}flDebugNeutral{% endif %}">
                        {{ op.operation|title }}
                    </td>
                    <td class="flDebugCode">{{ op.key }}</td>
                    <td>{{ op.result or 'N/A' }}</td>
                    <td>
                        {% if op.duration %}
                            {{ "%.2f"|format(op.duration) }}ms
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                    <td>{{ "%.3f"|format(op.timestamp) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
    
    <!-- Performance Analysis -->
    {% if queries and cache_operations %}
    <div class="flDebugPanelSection">
        <h4>Performance Analysis</h4>
        <div class="flDebugAnalysis">
            {% set cache_hits = cache_operations | selectattr('operation', 'equalto', 'hit') | list | length %}
            {% set cache_misses = cache_operations | selectattr('operation', 'equalto', 'miss') | list | length %}
            {% set cache_total = cache_hits + cache_misses %}
            
            <p><strong>Cache Efficiency:</strong></p>
            <ul>
                <li>Cache hit rate: {{ "%.1f"|format((cache_hits / cache_total * 100) if cache_total > 0 else 0) }}% ({{ cache_hits }}/{{ cache_total }})</li>
                <li>Queries executed: {{ total_queries }}</li>
                <li>
                    {% if cache_hits > total_queries %}
                        <span class="flDebugGood">âœ“ More cache hits than database queries - excellent caching!</span>
                    {% elif cache_hits == total_queries %}
                        <span class="flDebugGood">âœ“ Cache hits match database queries - good caching strategy</span>
                    {% else %}
                        <span class="flDebugWarning">âš  More database queries than cache hits - consider improving cache strategy</span>
                    {% endif %}
                </li>
            </ul>
            
            <p><strong>Recommendations:</strong></p>
            <ul>
                {% if total_queries > 5 %}
                <li class="flDebugWarning">Consider reducing the number of database queries through better caching or query optimization</li>
                {% endif %}
                {% if cache_total == 0 %}
                <li class="flDebugBad">No cache operations detected - implement caching to improve performance</li>
                {% elif (cache_hits / cache_total * 100) < 50 %}
                <li class="flDebugWarning">Low cache hit rate - review cache keys and expiration times</li>
                {% endif %}
                {% if total_time > 500 %}
                <li class="flDebugWarning">High total query time - consider query optimization or indexing</li>
                {% endif %}
            </ul>
        </div>
    </div>
    {% endif %}
</div>

<style>
.flDebugTable {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 10px;
}

.flDebugTable th,
.flDebugTable td {
    padding: 5px 10px;
    border: 1px solid #ddd;
    text-align: left;
    vertical-align: top;
}

.flDebugTable th {
    background-color: #f5f5f5;
    font-weight: bold;
}

.flDebugGood {
    color: #28a745;
    font-weight: bold;
}

.flDebugBad {
    color: #dc3545;
    font-weight: bold;
}

.flDebugWarning {
    color: #ffc107;
    font-weight: bold;
}

.flDebugNeutral {
    color: #6c757d;
}

.flDebugCode {
    font-family: monospace;
    background-color: #f8f9fa;
    padding: 5px;
    border-radius: 3px;
    font-size: 12px;
    white-space: pre-wrap;
    word-break: break-all;
}

.flDebugPanelSection {
    margin-bottom: 20px;
}

.flDebugPanelSection h4 {
    margin-bottom: 10px;
    color: #333;
    border-bottom: 1px solid #ddd;
    padding-bottom: 5px;
}

.flDebugQuery {
    background-color: #fafafa;
}

.flDebugQueryHeader {
    display: flex;
    align-items: center;
    gap: 10px;
}

.flDebugQueryTime {
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 11px;
    font-weight: bold;
}

.flDebugCacheCorrelation {
    background-color: #e7f3ff;
    color: #0066cc;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 11px;
    font-weight: bold;
}

.flDebugQuerySQL,
.flDebugQueryParams {
    margin: 10px 0;
}

.flDebugAnalysis {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 5px;
    border-left: 4px solid #007bff;
}

.flDebugAnalysis ul {
    margin: 5px 0;
    padding-left: 20px;
}

.flDebugAnalysis li {
    margin: 5px 0;
}
</style>