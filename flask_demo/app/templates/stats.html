{% extends "base.html" %}

{% block title %}Cache Statistics - Flask Caching Demo{% endblock %}

{% block content %}
<div class="stats-page">
    <div class="page-header">
        <h1>Cache Statistics</h1>
        <p>Detailed cache performance metrics and key inspection.</p>
    </div>
    
    <div class="stats-grid">
        <!-- Cache Status -->
        <div class="stat-section">
            <h2>Cache Status</h2>
            <div class="status-info">
                <div class="status-item">
                    <span class="status-label">Status:</span>
                    <span class="status-value {{ 'success' if cache_stats.status == 'connected' else 'error' }}">
                        {{ cache_stats.status|title }}
                    </span>
                </div>
                <div class="status-item">
                    <span class="status-label">Type:</span>
                    <span class="status-value">{{ cache_stats.cache_type|title }}</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Default Timeout:</span>
                    <span class="status-value">{{ cache_stats.default_timeout }}s</span>
                </div>
                {% if cache_stats.key_prefix %}
                <div class="status-item">
                    <span class="status-label">Key Prefix:</span>
                    <span class="status-value">{{ cache_stats.key_prefix }}</span>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Performance Metrics -->
        <div class="stat-section">
            <h2>Performance Metrics</h2>
            <div class="metrics-grid">
                <div class="metric-card">
                    <h3>Hit Rate</h3>
                    <div class="metric-value">{{ cache_stats.hit_rate }}%</div>
                    <div class="metric-detail">{{ cache_stats.hits }} hits / {{ cache_stats.total_operations }} total</div>
                </div>
                
                <div class="metric-card">
                    <h3>Cache Hits</h3>
                    <div class="metric-value">{{ cache_stats.hits }}</div>
                    <div class="metric-detail">Successful cache retrievals</div>
                </div>
                
                <div class="metric-card">
                    <h3>Cache Misses</h3>
                    <div class="metric-value">{{ cache_stats.misses }}</div>
                    <div class="metric-detail">Cache not found, computed fresh</div>
                </div>
                
                <div class="metric-card">
                    <h3>Cache Sets</h3>
                    <div class="metric-value">{{ cache_stats.sets }}</div>
                    <div class="metric-detail">Values stored in cache</div>
                </div>
                
                <div class="metric-card">
                    <h3>Cache Deletes</h3>
                    <div class="metric-value">{{ cache_stats.deletes }}</div>
                    <div class="metric-detail">Keys removed from cache</div>
                </div>
                
                <div class="metric-card">
                    <h3>Errors</h3>
                    <div class="metric-value {{ 'error' if cache_stats.errors > 0 else 'success' }}">{{ cache_stats.errors }}</div>
                    <div class="metric-detail">Cache operation failures</div>
                </div>
            </div>
        </div>
        
        <!-- Memory Usage (if available) -->
        {% if cache_stats.memory_used %}
        <div class="stat-section">
            <h2>Memory Usage</h2>
            <div class="memory-info">
                <div class="memory-item">
                    <span class="memory-label">Current Usage:</span>
                    <span class="memory-value">{{ cache_stats.memory_used }}</span>
                </div>
                <div class="memory-item">
                    <span class="memory-label">Peak Usage:</span>
                    <span class="memory-value">{{ cache_stats.memory_peak }}</span>
                </div>
                {% if cache_stats.keyspace_hits is defined %}
                <div class="memory-item">
                    <span class="memory-label">Keyspace Hits:</span>
                    <span class="memory-value">{{ cache_stats.keyspace_hits }}</span>
                </div>
                <div class="memory-item">
                    <span class="memory-label">Keyspace Misses:</span>
                    <span class="memory-value">{{ cache_stats.keyspace_misses }}</span>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- Cache Keys -->
        {% if cache_keys %}
        <div class="stat-section full-width">
            <h2>Cache Keys (Sample)</h2>
            <div class="keys-table-container">
                <table class="keys-table">
                    <thead>
                        <tr>
                            <th>Cache Key</th>
                            <th>Type</th>
                            <th>TTL (seconds)</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for key_info in cache_keys %}
                        <tr>
                            <td class="key-name">{{ key_info.key }}</td>
                            <td class="key-type">{{ key_info.type }}</td>
                            <td class="key-ttl">
                                {% if key_info.ttl == -1 %}
                                    No expiry
                                {% elif key_info.ttl == -2 %}
                                    Expired
                                {% else %}
                                    {{ key_info.ttl }}s
                                {% endif %}
                            </td>
                            <td class="key-status">
                                {% if key_info.ttl == -2 %}
                                    <span class="status-expired">Expired</span>
                                {% elif key_info.ttl == -1 %}
                                    <span class="status-persistent">Persistent</span>
                                {% elif key_info.ttl < 60 %}
                                    <span class="status-expiring">Expiring Soon</span>
                                {% else %}
                                    <span class="status-active">Active</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <p class="keys-note">Showing first 50 cache keys. Use cache management tools to inspect specific patterns.</p>
        </div>
        {% endif %}
    </div>
    
    <div class="actions-section">
        <h2>Cache Actions</h2>
        <div class="actions-grid">
            <a href="{{ url_for('main.clear_cache') }}" class="btn btn-secondary">Manage Cache</a>
            <a href="{{ url_for('main.warm_cache') }}" class="btn btn-primary">Warm Cache</a>
            <a href="{{ url_for('main.cache_stats') }}" class="btn btn-secondary">Refresh Stats</a>
        </div>
    </div>
    
    <div class="debug-section">
        <h2>Debug Toolbar Integration</h2>
        <p>The Flask Debug Toolbar provides real-time monitoring capabilities:</p>
        <div class="debug-features">
            <div class="debug-feature">
                <h4>Database Panel</h4>
                <p>Shows SQL queries executed, execution time, and query optimization suggestions</p>
            </div>
            <div class="debug-feature">
                <h4>Cache Panel</h4>
                <p>Displays cache operations, hit/miss ratios, and cache key inspection for each request</p>
            </div>
            <div class="debug-feature">
                <h4>Profiler Panel</h4>
                <p>Provides detailed request timing breakdown and identifies performance bottlenecks</p>
            </div>
            <div class="debug-feature">
                <h4>Template Panel</h4>
                <p>Shows template rendering time and context variables passed to templates</p>
            </div>
        </div>
        {% if config.DEBUG %}
        <div class="debug-status">
            <p><strong>Status:</strong> Debug toolbar is active and collecting metrics</p>
        </div>
        {% else %}
        <div class="debug-status warning">
            <p><strong>Note:</strong> Debug toolbar is disabled in production mode</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}